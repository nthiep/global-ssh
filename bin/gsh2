#!/bin/sh
### BEGIN INIT INFO
# Provides:          gss
# Required-Start:    $local_fs $network $named $time $syslog
# Required-Stop:     $local_fs $network $named $time $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       server global ssh service deamon 
### END INIT INFO
. /lib/lsb/init-functions
SCRIPT=/usr/local/bin/handle.py

PIDFILE=/var/run/gss.pid
LOGFILE=/var/log/gss.log
check_root(){
if [ `id -u` -ne 0 ]; then
   echo "You need root privileges to run service"
   exit 1
fi
}
start() {
  check_root
  log_daemon_msg "Starting global ssh service" "gsh" || true
  if start-stop-daemon --start --quiet --background --oknodo --pidfile $PIDFILE --exec $SCRIPT; then
    
    log_end_msg 0 || true
  else
    log_end_msg 1 || true
  fi
  echo 'Starting service…' >&2
  #local CMD="$SCRIPT &> \"$LOGFILE\" & echo \$!"
  #su -c "$CMD" > "$PIDFILE"
  #start_daemon -p $PIDFILE $SCRIPT
  echo 'Service started' >&2
}

stop() {
  check_root
  log_daemon_msg "Stoping global ssh server" "gsh" || true
  if start-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE --exec $SCRIPT; then
    log_end_msg 0 || true
  else
    log_end_msg 1 || true
  fi
  #echo 'Stopping service…' >&2
  #kill -15 $(cat "$PIDFILE") && rm -f "$PIDFILE"
 # echo 'Service stopped' >&2
}

status() {
  if [ -f $PIDFILE ] && kill -0 $(cat $PIDFILE); then
    echo 'Service already running at PID: $(cat $PIDFILE)' >&2
    return 1
  fi
  echo 'Service not running' >&2
}
uninstall() {
  check_root
  echo -n "Are you really sure you want to uninstall this service? That cannot be undone. [yes|No] "
  local SURE
  read SURE
  if [ "$SURE" = "yes" ]; then
    stop
    rm -f "$PIDFILE"
    echo "Notice: log file is not be removed: '$LOGFILE'" >&2
    update-rc.d -f gss remove
    rm -fv "$0"
  fi
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  status)
    status_of_proc -p $PIDFILE $SCRIPT gss && exit 0 || exit $?
    ;;
  uninstall)
    uninstall
    ;;
  retart)
    check_root
    stop
    start
    ;;
  *)
    echo " * Usage: $0 {start|stop|restart|status|uninstall}"
esac