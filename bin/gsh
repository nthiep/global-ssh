#!/usr/bin/env python
#
# Name: 		Global SSH Client
# Description:	help connect ssh between client behind NAT.
#				ssh use paramiko
# project 2
#
# Author: 		Nguyen Thanh Hiep - Nguyen Huu Dinh
# Time: 		2014/10
# Requirements: paramiko, ecdsa
#

import shlex
import sys
import os
import time
import readline
from optparse import OptionParser
from optparse import OptionGroup
import getpass
from gsh import Request
request = Request()
def Main():
	parser = OptionParser(description='global-ssh help connect ssh to peer behind NAT',
                                   prog='global-ssh',
                                   version='global-ssh 1.2',
                                   usage='%prog [-h] or [--help] to view help\n\t[-q] to quit program')
	group = OptionGroup(parser, "register, login account")
	group.add_option("-s", "--login", action ='store_true', default=False,
        help="login to server")
	group.add_option("-r", "--register", action ='store_true', default=False, 
		help="register new account")
	parser.add_option_group(group)

	group = OptionGroup(parser, "connect to peer")	#create group of parser
	group.add_option("-c", "--connect", metavar="p",
        help="-c [hostname] connect to peer") # add option parser
	group.add_option("-n", "--net", metavar="p",
        help="-n [net name] add network")
	parser.add_option_group(group)

	group = OptionGroup(parser, "show infomation of peer")
	group.add_option("-l", "--list", action ='store_true', default=False,
        help="show peer online")
	group.add_option("-g", "--logs", action ='store_true', default=False,
        help="show logs")
	parser.add_option_group(group)

	parser.add_option("-q", "--quiet",
	 action="store_true", default=False, help="exit program")

	options, args = parser.parse_args()
	processparser(options)
def superuser():
	if os.geteuid() != 0:
		print "You must a root to run this action!"
		args = ['sudo', sys.executable] + sys.argv + [os.environ]
		# the next line replaces the currently-running process with the sudo
		os.execlpe('sudo', *args)

def processparser(options):
	if options.register:
		user = raw_input("username: ")		
		pswd = getpass.getpass('Password for %s: ' % user)			
		repswd = getpass.getpass('confirm password: ')
		if pswd != repswd:
			print 'error: confirm password not match!'
			return
		if not request.register(user, pswd):
			os._exit(1)

	if options.login:
		superuser()
		user = raw_input("username: ")	
		pswd = getpass.getpass('Password for %s:' % user)
		if not request.login(user, pswd):
			print "login False"
			return
	if options.connect is not None:		
		request.connect(options.connect)
	if options.net is not None:
		request.addnetwork(options.net)
	if options.list:
		request.listmachine()
	if options.logs:
		request.logs()
	if options.quiet:
		print "\nquitting...."
		os._exit(1)

Main()